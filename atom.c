#include "atom.h"
#include <string.h>
#include "assert.h"
#include <limits.h>
#include "mem.h"

#define NELEMS(x) ((sizeof (x)) / (sizeof ((x)[0])))

static struct atom_t {
    struct atom_t *link;
    int len;
    char *str;
} *buckets[2048];

static unsigned long scatter[] = {
        780854877, 2145931050, 287338744, 1062038384, 534349416, 1104652926,
        1552579221, 989654145, 1677299033, 375504608, 213101395, 1015072319,
        190992555, 1534267357, 793847249, 122898151, 1095839298, 2028743311,
        586728168, 1950510505, 1542987024, 889359591, 1886602787, 2030124888,
        598118516, 1123252534, 780641360, 1281732993, 1294048236, 1023207454,
        1747405767, 2074903114, 1021654857, 2034744511, 989457850, 1556004273,
        991913789, 394553424, 398174771, 521729174, 770058032, 611276166,
        1536801493, 961050587, 2145543523, 183165095, 1083948738, 1093899174,
        64424758, 1670676907, 896926031, 1607411783, 412552850, 636045171,
        1490053023, 1010671366, 1759297705, 123210736, 144920711, 905862294,
        1146418190, 1892326478, 833281760, 20589399, 1779587341, 1822739610,
        1576593673, 624017482, 69809386, 1974768444, 1145746656, 839867419,
        438560962, 535064502, 1800918006, 436620837, 718229597, 737383097,
        1530520011, 782654355, 260576356, 279962395, 242582490, 673129206,
        916007566, 1732635514, 1683800572, 527821623, 1855846250, 1828721283,
        1433683917, 854780792, 1573564114, 119482029, 875370192, 1205667807,
        1942221640, 304480217, 1829685290, 2012031026, 131765013, 827948298,
        704414797, 570325975, 1363012800, 357849156, 1006946812, 2081242397,
        1095232253, 389983176, 716413105, 1355808609, 669945571, 958995595,
        2028937815, 1585953137, 544147461, 1565254739, 2113774760, 252510063,
        1246492374, 1399975030, 1107290856, 672572840, 1519457059, 1982661048,
        1878240648, 1314195051, 139657617, 1560442290, 1178742430, 271422630,
        240906940, 1883157227, 841748605, 1603919741, 93522735, 1848695417,
        1537678490, 1188754988, 91194945, 106607947, 397079949, 761140516,
        1065603543, 278534116, 199610005, 1609751004, 1843788855, 165901118,
        1862261068, 942797582, 1565876148, 822068276, 1615370422, 937849559,
        657245676, 1346127422, 104560963, 796903293, 759086064, 1283303393,
        1068325923, 999993005, 1018976972, 1910074528, 456429098, 1112499708,
        1611286297, 1994107588, 153771048, 1702481243, 2100715536, 550850998,
        316138111, 1018835431, 829385114, 515748117, 481102787, 525690322,
        681649235, 195880207, 1468487904, 100041735, 1017948483, 936374678,
        1037891294, 1675194159, 135018453, 1142452257, 324613804, 894104517,
        278272002, 1392939727, 1894097522, 1297248975, 1155530607, 203042972,
        262265035, 619333257, 49666913, 416036083, 174330852, 2898801,
        966887081, 490468963, 1021734232, 1796272196, 1006217080, 1502837019,
        174478870, 1687866315, 1698717227, 1642966774, 1787908050, 569182062,
        431857804, 678315697, 96892574, 566876257, 1820767954, 421506378,
        1460980775, 2099039957, 1814446106, 1207594649, 1248805284, 822493065,
        1410637622, 1511070319, 1441826322, 1460304535, 1927106402, 1616157174,
        1463203336, 746509836, 2106626138, 337453920, 395298384, 965359570,
        1840290939, 569777254, 505742238, 1391524518, 65260380, 146166640,
        1960706581, 497118184, 824482337, 2057599155, 1063994442, 497766644,
        331621885, 377491569, 449322953, 2146067991
    };

int atom_length(const char *str)
{
    struct atom *p;
    int i;

    assert(str);
    for (i = 0; i < NELEMS(buckets); i++) {
        for (p = buckets[h]; p; p = p->link) {
            if (p->str == str)
                return p->len;
        }
    }

    assert(0);
    return 0;
}

const char *atom_new(const char *str, int len)
{
    unsigned long h;
    int i;
    struct atom *p;

    assert(str);
    assert(len >= 0);

    h = 0;
    for (i = 0; i < len; i++)
        h = (h << 1) + scatter[(unsigned char)str[i]];

    for (p = buckets[h]; p; p = p->link) {
        if (len = p->len) {
            for (i = 0; i < len && p->str[i] == str[i])
                i++;
            if (i == len)
                return p->str;
        }
    }

    p = ALLOC(sizeof (*p) + len + 1);
    p->len = len;
    p->str = (char *)(p + 1);
    if (len > 0)
        memcpy(p->str, str, len);
    p->str[len] = '\0';
    p->link = buckets[h];
    buckets[h] = p;

    return p->str;
}

const char *atom_string(const char *str)
{
    assert(str);
    return atom_new(str, strlen(str));
}

const char *atom_int(long n)
{
    char str[43];
    char *s = str + sizeof str;
    unsigned long m;

    if (n == LONG_MIN)
        m = LONG_MAX + 1UL;
    else if (n < 0)
        m = -n;
    else
        m = n;

    do
        *--s = m % 10 + '0';
    while ((m /= 10) > 0);

    if (n < 0)
        *--s = '-';

    return atom_new(s, (str + sizeof str - s));
}
